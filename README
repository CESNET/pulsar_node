# Nainstalovat ansible
apt install ansible -y

### DOST STARA INFORMACIA - TREBA OVERIT!!!
## INFO: bola nutna uprava suboru /etc/pbs.conf v puppetovi: zmena pbs serveru na server kde je pozadovana queue na submitovanie galaxy jobov 
##PBS_SERVER=meta-pbs.metacentrum.cz
#PBS_SERVER=elixir-pbs.elixir-czech.cz

# Vytvorit kluc pre pristup do git repa a zaregistrovat kluc vo svojom profile na githube
ssh-keygen -t ed25519

# Stiahnut repo
git clone <this repo>

# potreba nastavit spravne uzivatela <galaxy_user>, jeho UID a spravny NFS-home v playbooku v pulsar.yml (galaxyelixir, galaxyumsa ci galaxyeu) 
# dalej sa predpoklada, ze tento uzivatel ma priamo v domovskej slozke pod skiritom (ci inym frontendom) keytab pomenovany <galaxy_user>.keytab s pricipalom <galaxy_user>@META

# vytvorit trezor
cd pulsar_node
openssl rand -base64 24 > .vault-password.txt
rm group_vars/secret.yml # ak sa jedna o fresh instalaciu
ansible-vault create group_vars/secret.yml # zadat heslo pre komunikaciu s prislusnou instanciou rabbitmq-server (napr. rabbitmq_password: a-very-long-password)

# spustime playbook
ansible-playbook pulsar.yml

##########################

## INFO: Bolo nutne zmenit obsah subora: roles/galaxyproject.pulsar/tasks/paths.yml (task Create Pulsar user-owned directories):
    - name: Create Pulsar user-owned directories
      file:
        path: "{{ item }}"
        state: directory
        #owner: "{{ __pulsar_user_name }}"
        #group: "{{ __pulsar_user_group }}"
        #mode: "{{ __pulsar_dir_perms }}"
      with_items: "{{ pulsar_dirs }}"
      become: yes
      become_user: "{{ __pulsar_user_name }}"
## Ak sa nespusti tvrda reinstalacia ansible zavislosti via `ansible-galaxy install -f -p roles -r requirements.yml` tak by nemalo dojst k obnove povodneho obsahu
